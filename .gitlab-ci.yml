stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master

# Deploy to DigitalOcean
# OPS Team: Please configure the deployment method below based on infrastructure decision
# See OPS_DEPLOYMENT_REQUEST.md for details
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
  script:
    - |
      echo "Deploying HelloWorld app to DigitalOcean..."
      
      # OPS Team: Uncomment and configure ONE of the following deployment methods:
      
      # ============================================
      # Option 1: DigitalOcean App Platform (Webhook)
      # ============================================
      # if [ -n "$DIGITALOCEAN_DEPLOY_WEBHOOK_URL" ]; then
      #   echo "Triggering App Platform deployment via webhook..."
      #   curl -X POST "$DIGITALOCEAN_DEPLOY_WEBHOOK_URL"
      #   echo "Webhook triggered successfully"
      # else
      #   echo "Error: DIGITALOCEAN_DEPLOY_WEBHOOK_URL not set"
      #   exit 1
      # fi
      
      # ============================================
      # Option 2: DigitalOcean Droplet (SSH)
      # ============================================
      # if [ -n "$DIGITALOCEAN_SSH_HOST" ] && [ -n "$DIGITALOCEAN_SSH_USER" ]; then
      #   echo "Deploying to Droplet via SSH..."
      #   mkdir -p ~/.ssh
      #   echo "$DIGITALOCEAN_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
      #   chmod 600 ~/.ssh/id_rsa
      #   ssh -o StrictHostKeyChecking=no -p ${DIGITALOCEAN_SSH_PORT:-22} \
      #     $DIGITALOCEAN_SSH_USER@$DIGITALOCEAN_HOST << 'EOF'
      #     docker pull $CI_REGISTRY_IMAGE:latest
      #     docker stop test-ai-app || true
      #     docker rm test-ai-app || true
      #     docker run -d -p 80:80 --name test-ai-app --restart unless-stopped $CI_REGISTRY_IMAGE:latest
      # EOF
      #   echo "Deployment to Droplet completed"
      # else
      #   echo "Error: SSH credentials not configured"
      #   exit 1
      # fi
      
      # ============================================
      # Option 3: DigitalOcean Kubernetes
      # ============================================
      # if [ -n "$DIGITALOCEAN_KUBECONFIG" ]; then
      #   echo "Deploying to Kubernetes..."
      #   mkdir -p ~/.kube
      #   echo "$DIGITALOCEAN_KUBECONFIG" > ~/.kube/config
      #   kubectl set image deployment/test-ai-app test-ai-app=$CI_REGISTRY_IMAGE:latest -n ${DIGITALOCEAN_NAMESPACE:-default}
      #   kubectl rollout status deployment/test-ai-app -n ${DIGITALOCEAN_NAMESPACE:-default}
      #   echo "Kubernetes deployment completed"
      # else
      #   echo "Error: KUBECONFIG not set"
      #   exit 1
      # fi
      
      # Temporary placeholder - OPS team needs to configure above
      echo "⚠️  WARNING: Deployment method not configured by OPS team"
      echo "Please see OPS_DEPLOYMENT_REQUEST.md and configure deployment in .gitlab-ci.yml"
      echo "Deployment stage completed (no action taken)"
  only:
    - main
    - master
  when: manual
  environment:
    name: production
    url: ${APP_URL:-https://your-app-url.com}

